<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test Vector Tile Overlays with Proxy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map { 
            position: absolute; 
            top: 160px; 
            bottom: 0; 
            width: 100%; 
        }
        .controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.secondary {
            background: #2196F3;
        }
        .test-button.secondary:hover {
            background: #1976D2;
        }
        .test-button.danger {
            background: #f44336;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        .coordinates {
            position: absolute;
            top: 170px;
            right: 10px;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            font-family: monospace;
        }
        .overlay-control {
            position: absolute;
            top: 210px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .overlay-control label {
            font-size: 12px;
            display: block;
            margin-bottom: 5px;
        }
        .overlay-control input {
            width: 150px;
        }
    </style>
</head>
<body>

<div class="controls">
    <h3 style="margin: 0 0 10px 0;">Vector Tile Overlay Test - With Proxy</h3>
    <div class="test-buttons">
        <button class="test-button" onclick="loadBasemapStandard()">
            Load Basemap Standard
        </button>
        <button class="test-button secondary" onclick="addKatasterBEV2()">
            Add Kataster BEV2
        </button>
        <button class="test-button secondary" onclick="addDKMSymbole()">
            Add DKM Symbole
        </button>
        <button class="test-button secondary" onclick="addKTNKataster()">
            Add KTN Kataster
        </button>
        <button class="test-button secondary" onclick="testFullSetup()">
            Test Full Setup
        </button>
        <button class="test-button danger" onclick="clearAll()">
            Clear All
        </button>
    </div>
    <div class="status" id="status">Ready to test vector overlays</div>
</div>

<div id="map"></div>
<div class="coordinates" id="coordinates">Lat: 47.5000, Lng: 13.3000</div>

<div class="overlay-control">
    <label>Overlay Opacity: <span id="opacity-value">70%</span></label>
    <input type="range" id="opacity-slider" min="0" max="100" value="70" onchange="updateOpacity()" />
</div>

<script>
let map = null;
let currentOverlays = {};

// Initialize empty map
function initMap() {
    if (map) {
        map.remove();
    }
    
    map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {},
            layers: []
        },
        center: [13.3, 47.5], // Austria center
        zoom: 7
    });
    
    map.on('mousemove', (e) => {
        document.getElementById('coordinates').textContent = 
            `Lat: ${e.lngLat.lat.toFixed(4)}, Lng: ${e.lngLat.lng.toFixed(4)}`;
    });
    
    map.addControl(new maplibregl.NavigationControl());
}

// Load Basemap Standard
async function loadBasemapStandard() {
    document.getElementById('status').textContent = 'Loading Basemap Standard...';
    
    try {
        // Load the basemap style
        const response = await fetch('https://gis.ktn.gv.at/osgdi/styles/basemap_ktn_vektor.json');
        const style = await response.json();
        
        // Set the style
        map.setStyle(style);
        
        map.once('style.load', () => {
            document.getElementById('status').textContent = 'Basemap Standard loaded';
        });
    } catch (error) {
        console.error('Error loading basemap:', error);
        // Fallback to raster basemap
        map.setStyle({
            version: 8,
            sources: {
                'basemap': {
                    type: 'raster',
                    tiles: ['https://mapsneu.wien.gv.at/basemap/geolandbasemap/normal/google3857/{z}/{y}/{x}.png'],
                    tileSize: 256
                }
            },
            layers: [{
                id: 'basemap-layer',
                type: 'raster',
                source: 'basemap'
            }]
        });
        document.getElementById('status').textContent = 'Loaded fallback raster basemap';
    }
}

// Add Kataster BEV2 overlay
async function addKatasterBEV2() {
    document.getElementById('status').textContent = 'Adding Kataster BEV2...';
    
    try {
        // Use proxied URL for tiles
        const tilesUrl = '/kataster-tiles/styles/kataster/tiles.json';
        
        // Try to fetch the tilejson through proxy
        const response = await fetch(tilesUrl);
        const tileJson = await response.json();
        
        // Add the source
        map.addSource('kataster-bev2', {
            type: 'vector',
            tiles: tileJson.tiles.map(url => url.replace('https://kataster.bev.gv.at', '/kataster-tiles')),
            minzoom: tileJson.minzoom || 0,
            maxzoom: tileJson.maxzoom || 22
        });
        
        // Add layers
        addKatasterLayers('kataster-bev2');
        
        currentOverlays['kataster-bev2'] = true;
        document.getElementById('status').textContent = 'Added Kataster BEV2 overlay';
    } catch (error) {
        console.error('Error adding Kataster BEV2:', error);
        
        // Fallback: add directly without fetching tilejson
        try {
            map.addSource('kataster-bev2', {
                type: 'vector',
                tiles: ['/kataster-tiles/styles/kataster/{z}/{x}/{y}.pbf'],
                minzoom: 0,
                maxzoom: 22
            });
            
            addKatasterLayers('kataster-bev2');
            currentOverlays['kataster-bev2'] = true;
            document.getElementById('status').textContent = 'Added Kataster BEV2 overlay (fallback)';
        } catch (fallbackError) {
            document.getElementById('status').textContent = 'Error: ' + fallbackError.message;
        }
    }
}

// Add DKM Symbole overlay
async function addDKMSymbole() {
    document.getElementById('status').textContent = 'Adding DKM Symbole...';
    
    try {
        // Use proxied URL
        map.addSource('dkm-symbole', {
            type: 'vector',
            tiles: ['/kataster-tiles/styles/symbole/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 22
        });
        
        // Add symbol layers
        const opacity = document.getElementById('opacity-slider').value / 100;
        
        map.addLayer({
            id: 'dkm-symbole-points',
            type: 'circle',
            source: 'dkm-symbole',
            'source-layer': 'default',
            paint: {
                'circle-radius': 4,
                'circle-color': '#0000ff',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': 1,
                'circle-opacity': opacity
            }
        });
        
        currentOverlays['dkm-symbole'] = true;
        document.getElementById('status').textContent = 'Added DKM Symbole overlay';
    } catch (error) {
        console.error('Error adding DKM Symbole:', error);
        document.getElementById('status').textContent = 'Error: ' + error.message;
    }
}

// Add KTN Kataster overlay
async function addKTNKataster() {
    document.getElementById('status').textContent = 'Adding KTN Kataster...';
    
    try {
        // Use proxied URL
        map.addSource('ktn-kataster', {
            type: 'vector',
            tiles: ['/ktn-tiles/osgdi/tilesets/gst_bev/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 22
        });
        
        // Add layers
        addKatasterLayers('ktn-kataster', 'gst_bev_fill');
        
        currentOverlays['ktn-kataster'] = true;
        document.getElementById('status').textContent = 'Added KTN Kataster overlay';
    } catch (error) {
        console.error('Error adding KTN Kataster:', error);
        document.getElementById('status').textContent = 'Error: ' + error.message;
    }
}

// Helper function to add kataster layers
function addKatasterLayers(sourceId, sourceLayer = 'Grundstücke - Flächen') {
    const opacity = document.getElementById('opacity-slider').value / 100;
    
    // Add fill layer
    map.addLayer({
        id: `${sourceId}-fill`,
        type: 'fill',
        source: sourceId,
        'source-layer': sourceLayer,
        paint: {
            'fill-color': 'rgba(255, 0, 0, 0.05)',
            'fill-opacity': opacity * 0.3
        }
    });
    
    // Add line layer
    map.addLayer({
        id: `${sourceId}-line`,
        type: 'line',
        source: sourceId,
        'source-layer': sourceLayer,
        paint: {
            'line-color': '#ff0000',
            'line-width': 1.5,
            'line-opacity': opacity
        }
    });
}

// Test full setup
async function testFullSetup() {
    await loadBasemapStandard();
    
    setTimeout(async () => {
        await addKatasterBEV2();
        await addDKMSymbole();
        
        // Zoom to Klagenfurt
        map.flyTo({
            center: [14.3053, 46.6364],
            zoom: 15,
            duration: 2000
        });
        
        document.getElementById('status').textContent = 'Full setup complete - zooming to Klagenfurt';
    }, 1000);
}

// Clear all overlays
function clearAll() {
    // Remove overlay layers
    Object.keys(currentOverlays).forEach(overlayId => {
        try {
            const layers = map.getStyle().layers.filter(l => l.id.includes(overlayId));
            layers.forEach(layer => {
                if (map.getLayer(layer.id)) {
                    map.removeLayer(layer.id);
                }
            });
            if (map.getSource(overlayId)) {
                map.removeSource(overlayId);
            }
        } catch (e) {
            console.error('Error removing overlay:', e);
        }
    });
    currentOverlays = {};
    document.getElementById('status').textContent = 'Cleared all overlays';
}

// Update opacity
function updateOpacity() {
    const opacity = document.getElementById('opacity-slider').value / 100;
    document.getElementById('opacity-value').textContent = `${document.getElementById('opacity-slider').value}%`;
    
    // Update opacity for all overlay layers
    Object.keys(currentOverlays).forEach(overlayId => {
        try {
            if (map.getLayer(`${overlayId}-fill`)) {
                map.setPaintProperty(`${overlayId}-fill`, 'fill-opacity', opacity * 0.3);
            }
            if (map.getLayer(`${overlayId}-line`)) {
                map.setPaintProperty(`${overlayId}-line`, 'line-opacity', opacity);
            }
            if (map.getLayer(`${overlayId}-points`)) {
                map.setPaintProperty(`${overlayId}-points`, 'circle-opacity', opacity);
            }
        } catch (e) {
            console.error('Error updating opacity:', e);
        }
    });
}

// Initialize map on load
initMap();
</script>

</body>
</html>