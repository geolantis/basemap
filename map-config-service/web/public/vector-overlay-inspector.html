<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Vector Overlay Inspector - Debug & Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map { 
            position: absolute; 
            top: 180px; 
            bottom: 0; 
            width: 100%; 
        }
        .controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 165px;
            overflow-y: auto;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .button.primary {
            background: #4CAF50;
            color: white;
        }
        .button.primary:hover {
            background: #45a049;
        }
        .button.secondary {
            background: #2196F3;
            color: white;
        }
        .button.secondary:hover {
            background: #1976D2;
        }
        .button.warning {
            background: #FF9800;
            color: white;
        }
        .button.warning:hover {
            background: #F57C00;
        }
        .button.danger {
            background: #f44336;
            color: white;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .log-entry {
            padding: 6px 10px;
            margin: 3px 0;
            background: #f5f5f5;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            border-left: 3px solid #ddd;
        }
        .log-entry.error {
            background: #ffebee;
            color: #c62828;
            border-left-color: #f44336;
        }
        .log-entry.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left-color: #4caf50;
        }
        .log-entry.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left-color: #2196f3;
        }
        .log-entry.warning {
            background: #fff3e0;
            color: #e65100;
            border-left-color: #ff9800;
        }
        .coordinates {
            position: absolute;
            top: 190px;
            right: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            font-family: monospace;
        }
        h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        h4 {
            margin: 0 0 8px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="controls">
    <h3>üîç Vector Overlay Inspector & Debugger</h3>
    <div class="test-buttons">
        <button class="button primary" onclick="loadRasterBasemap()">
            Load Raster Base
        </button>
        <button class="button secondary" onclick="testKatasterDirect()">
            Test Kataster Direct
        </button>
        <button class="button secondary" onclick="testKatasterProxy()">
            Test Kataster Proxy
        </button>
        <button class="button secondary" onclick="testDKMDirect()">
            Test DKM Direct
        </button>
        <button class="button secondary" onclick="testDKMProxy()">
            Test DKM Proxy
        </button>
        <button class="button warning" onclick="inspectTile()">
            Inspect Current Tile
        </button>
        <button class="button danger" onclick="clearAll()">
            Clear All
        </button>
    </div>
</div>

<div id="map"></div>
<div class="coordinates" id="coordinates">Zoom: 7 | Center: 13.30, 47.50</div>

<div class="info-panel">
    <h4>Debug Log</h4>
    <div id="log"></div>
</div>

<script>
let map = null;
let currentSources = [];

function log(message, type = 'info') {
    const logEl = document.getElementById('log');
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    const timestamp = new Date().toLocaleTimeString();
    entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
    logEl.insertBefore(entry, logEl.firstChild);
    console.log(`[${type.toUpperCase()}] ${message}`);
}

function clearLog() {
    document.getElementById('log').innerHTML = '';
}

// Initialize map with simple style
function initMap() {
    log('Initializing map...', 'info');
    
    map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {},
            layers: [],
            glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf'
        },
        center: [14.3053, 46.6364], // Klagenfurt
        zoom: 14
    });
    
    map.on('load', () => {
        log('Map initialized successfully', 'success');
        loadRasterBasemap();
    });
    
    map.on('error', (e) => {
        log(`Map error: ${e.error?.message || JSON.stringify(e)}`, 'error');
    });
    
    map.on('sourcedataloading', (e) => {
        if (e.tile) {
            log(`Loading tile from ${e.sourceId}`, 'info');
        }
    });
    
    map.on('sourcedata', (e) => {
        if (e.isSourceLoaded && e.sourceDataType === 'visibility') {
            log(`Source ${e.sourceId} fully loaded`, 'success');
            
            // Try to inspect the source
            const source = map.getSource(e.sourceId);
            if (source && source.type === 'vector') {
                // Check for vector layers in tiles
                setTimeout(() => {
                    const layers = map.getStyle().layers;
                    const sourceLayers = new Set();
                    layers.forEach(layer => {
                        if (layer.source === e.sourceId && layer['source-layer']) {
                            sourceLayers.add(layer['source-layer']);
                        }
                    });
                    if (sourceLayers.size > 0) {
                        log(`Found source-layers in ${e.sourceId}: ${Array.from(sourceLayers).join(', ')}`, 'success');
                    }
                }, 100);
            }
        }
    });
    
    map.on('move', () => {
        const center = map.getCenter();
        const zoom = map.getZoom();
        document.getElementById('coordinates').textContent = 
            `Zoom: ${zoom.toFixed(1)} | Center: ${center.lng.toFixed(2)}, ${center.lat.toFixed(2)}`;
    });
    
    map.addControl(new maplibregl.NavigationControl());
}

// Load a simple raster basemap
function loadRasterBasemap() {
    log('Loading raster basemap...', 'info');
    
    // Remove existing basemap if any
    if (map.getLayer('basemap')) {
        map.removeLayer('basemap');
    }
    if (map.getSource('basemap-raster')) {
        map.removeSource('basemap-raster');
    }
    
    map.addSource('basemap-raster', {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: '¬© OpenStreetMap contributors'
    });
    
    map.addLayer({
        id: 'basemap',
        type: 'raster',
        source: 'basemap-raster'
    });
    
    log('Raster basemap loaded', 'success');
}

// Test Kataster tiles directly
function testKatasterDirect() {
    clearOverlays();
    log('Testing Kataster tiles DIRECT (no proxy)...', 'info');
    
    const sourceId = 'kataster-direct';
    const tileUrl = 'https://kataster.bev.gv.at/styles/kataster/{z}/{x}/{y}.pbf';
    
    try {
        map.addSource(sourceId, {
            type: 'vector',
            tiles: [tileUrl],
            minzoom: 0,
            maxzoom: 22
        });
        
        currentSources.push(sourceId);
        log(`Added source: ${sourceId} with URL: ${tileUrl}`, 'success');
        
        // Try multiple possible source-layer names
        const possibleLayers = [
            'Grundst√ºcke - Fl√§chen',
            'Grundstuecke - Flaechen',
            'grundstuecke_flaechen',
            'grundstuecke',
            'parcels',
            'kataster',
            'default',
            'Grundst√ºcke',
            'flaechen'
        ];
        
        possibleLayers.forEach((layerName, index) => {
            try {
                const layerId = `${sourceId}-test-${index}`;
                map.addLayer({
                    id: layerId,
                    type: 'line',
                    source: sourceId,
                    'source-layer': layerName,
                    paint: {
                        'line-color': `hsl(${index * 40}, 100%, 50%)`,
                        'line-width': 2,
                        'line-opacity': 0.8
                    }
                });
                log(`‚úì Added layer with source-layer: "${layerName}"`, 'success');
            } catch (e) {
                log(`‚úó Failed with source-layer "${layerName}": ${e.message}`, 'warning');
            }
        });
        
    } catch (error) {
        log(`Error adding Kataster direct: ${error.message}`, 'error');
    }
}

// Test Kataster tiles through proxy
function testKatasterProxy() {
    clearOverlays();
    log('Testing Kataster tiles through PROXY...', 'info');
    
    const sourceId = 'kataster-proxy';
    const tileUrl = '/kataster-tiles/styles/kataster/{z}/{x}/{y}.pbf';
    
    try {
        map.addSource(sourceId, {
            type: 'vector',
            tiles: [tileUrl],
            minzoom: 0,
            maxzoom: 22
        });
        
        currentSources.push(sourceId);
        log(`Added source: ${sourceId} with proxied URL: ${tileUrl}`, 'success');
        
        // Try the most likely source-layer names first
        const possibleLayers = [
            'default',  // Most vector tiles use 'default'
            'Grundst√ºcke - Fl√§chen',
            'grundstuecke',
            'parcels',
            'kataster'
        ];
        
        possibleLayers.forEach((layerName, index) => {
            try {
                // Add fill layer
                map.addLayer({
                    id: `${sourceId}-fill-${index}`,
                    type: 'fill',
                    source: sourceId,
                    'source-layer': layerName,
                    paint: {
                        'fill-color': `hsl(${index * 60}, 70%, 50%)`,
                        'fill-opacity': 0.2
                    }
                });
                
                // Add line layer
                map.addLayer({
                    id: `${sourceId}-line-${index}`,
                    type: 'line',
                    source: sourceId,
                    'source-layer': layerName,
                    paint: {
                        'line-color': `hsl(${index * 60}, 100%, 40%)`,
                        'line-width': 2,
                        'line-opacity': 0.9
                    }
                });
                
                log(`‚úì Added layers with source-layer: "${layerName}"`, 'success');
            } catch (e) {
                log(`‚úó Failed with source-layer "${layerName}": ${e.message}`, 'warning');
            }
        });
        
    } catch (error) {
        log(`Error adding Kataster proxy: ${error.message}`, 'error');
    }
}

// Test DKM Symbole directly
function testDKMDirect() {
    clearOverlays();
    log('Testing DKM Symbole DIRECT (no proxy)...', 'info');
    
    const sourceId = 'dkm-direct';
    const tileUrl = 'https://kataster.bev.gv.at/styles/symbole/{z}/{x}/{y}.pbf';
    
    try {
        map.addSource(sourceId, {
            type: 'vector',
            tiles: [tileUrl],
            minzoom: 0,
            maxzoom: 22
        });
        
        currentSources.push(sourceId);
        log(`Added source: ${sourceId} with URL: ${tileUrl}`, 'success');
        
        // Try possible source-layer names for symbols
        const possibleLayers = [
            'default',
            'symbole',
            'punkte',
            'points',
            'Punkte & Symbole',
            'dkm_symbole'
        ];
        
        possibleLayers.forEach((layerName, index) => {
            try {
                map.addLayer({
                    id: `${sourceId}-points-${index}`,
                    type: 'circle',
                    source: sourceId,
                    'source-layer': layerName,
                    paint: {
                        'circle-radius': 5,
                        'circle-color': `hsl(${200 + index * 30}, 100%, 50%)`,
                        'circle-stroke-color': '#ffffff',
                        'circle-stroke-width': 2,
                        'circle-opacity': 0.9
                    }
                });
                log(`‚úì Added symbol layer with source-layer: "${layerName}"`, 'success');
            } catch (e) {
                log(`‚úó Failed with source-layer "${layerName}": ${e.message}`, 'warning');
            }
        });
        
    } catch (error) {
        log(`Error adding DKM direct: ${error.message}`, 'error');
    }
}

// Test DKM Symbole through proxy
function testDKMProxy() {
    clearOverlays();
    log('Testing DKM Symbole through PROXY...', 'info');
    
    const sourceId = 'dkm-proxy';
    const tileUrl = '/kataster-tiles/styles/symbole/{z}/{x}/{y}.pbf';
    
    try {
        map.addSource(sourceId, {
            type: 'vector',
            tiles: [tileUrl],
            minzoom: 0,
            maxzoom: 22
        });
        
        currentSources.push(sourceId);
        log(`Added source: ${sourceId} with proxied URL: ${tileUrl}`, 'success');
        
        // Try possible source-layer names
        const possibleLayers = [
            'default',
            'symbole',
            'punkte',
            'points'
        ];
        
        possibleLayers.forEach((layerName, index) => {
            try {
                // Add as circles
                map.addLayer({
                    id: `${sourceId}-circles-${index}`,
                    type: 'circle',
                    source: sourceId,
                    'source-layer': layerName,
                    paint: {
                        'circle-radius': 6,
                        'circle-color': `hsl(${280 + index * 20}, 100%, 50%)`,
                        'circle-stroke-color': '#000000',
                        'circle-stroke-width': 1,
                        'circle-opacity': 0.8
                    }
                });
                
                // Also try as symbols if there are icons
                map.addLayer({
                    id: `${sourceId}-symbols-${index}`,
                    type: 'symbol',
                    source: sourceId,
                    'source-layer': layerName,
                    layout: {
                        'text-field': ['get', 'name'],
                        'text-size': 12,
                        'text-offset': [0, 1]
                    },
                    paint: {
                        'text-color': '#000000',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 2
                    }
                });
                
                log(`‚úì Added symbol layers with source-layer: "${layerName}"`, 'success');
            } catch (e) {
                log(`‚úó Failed with source-layer "${layerName}": ${e.message}`, 'warning');
            }
        });
        
    } catch (error) {
        log(`Error adding DKM proxy: ${error.message}`, 'error');
    }
}

// Inspect current tile data
function inspectTile() {
    log('Inspecting current map state...', 'info');
    
    const style = map.getStyle();
    
    // Log all sources
    Object.entries(style.sources).forEach(([id, source]) => {
        if (source.type === 'vector') {
            log(`Vector source "${id}": ${source.tiles ? source.tiles[0] : 'no tiles'}`, 'info');
        }
    });
    
    // Log all layers with vector sources
    const vectorLayers = style.layers.filter(l => {
        const source = style.sources[l.source];
        return source && source.type === 'vector';
    });
    
    if (vectorLayers.length > 0) {
        log(`Found ${vectorLayers.length} vector layers:`, 'info');
        vectorLayers.forEach(layer => {
            const sourceLayer = layer['source-layer'] || 'NOT SET';
            const visibility = layer.layout?.visibility || 'visible';
            log(`Layer "${layer.id}": source="${layer.source}", source-layer="${sourceLayer}", visibility="${visibility}"`, 'info');
        });
    } else {
        log('No vector layers found', 'warning');
    }
    
    // Try to get actual tile data
    const zoom = Math.floor(map.getZoom());
    const center = map.getCenter();
    const tile = pointToTile(center.lng, center.lat, zoom);
    log(`Current tile coordinates: z=${zoom}, x=${tile[0]}, y=${tile[1]}`, 'info');
}

// Helper function to convert lng/lat to tile coordinates
function pointToTile(lng, lat, zoom) {
    const x = Math.floor((lng + 180) / 360 * Math.pow(2, zoom));
    const y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
    return [x, y];
}

// Clear all overlay layers
function clearOverlays() {
    const style = map.getStyle();
    
    // Remove all test layers
    const layersToRemove = style.layers.filter(l => 
        l.id.includes('-test-') || 
        l.id.includes('-fill-') || 
        l.id.includes('-line-') || 
        l.id.includes('-points-') ||
        l.id.includes('-circles-') ||
        l.id.includes('-symbols-')
    );
    
    layersToRemove.forEach(layer => {
        try {
            map.removeLayer(layer.id);
        } catch (e) {
            // Layer might already be removed
        }
    });
    
    // Remove sources
    currentSources.forEach(sourceId => {
        try {
            if (map.getSource(sourceId)) {
                map.removeSource(sourceId);
            }
        } catch (e) {
            // Source might already be removed
        }
    });
    
    currentSources = [];
    log('Cleared all overlay layers', 'info');
}

// Clear everything
function clearAll() {
    clearOverlays();
    clearLog();
    log('Cleared everything', 'success');
}

// Initialize on load
initMap();
</script>

</body>
</html>