<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test Overlays - Fixed Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map { 
            position: absolute; 
            top: 200px; 
            bottom: 0; 
            width: 100%; 
        }
        .controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 180px;
            overflow-y: auto;
        }
        .test-section {
            margin-bottom: 15px;
        }
        .test-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .test-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .test-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .test-button.primary {
            background: #4CAF50;
            color: white;
        }
        .test-button.primary:hover {
            background: #45a049;
        }
        .test-button.secondary {
            background: #2196F3;
            color: white;
        }
        .test-button.secondary:hover {
            background: #1976D2;
        }
        .test-button.warning {
            background: #ff9800;
            color: white;
        }
        .test-button.warning:hover {
            background: #e68900;
        }
        .test-button.danger {
            background: #f44336;
            color: white;
        }
        .test-button.danger:hover {
            background: #da190b;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
        }
        .coordinates {
            position: absolute;
            top: 210px;
            right: 10px;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            font-family: monospace;
        }
        .opacity-control {
            position: absolute;
            top: 250px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 200px;
        }
        .opacity-control label {
            font-size: 12px;
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .opacity-control input {
            width: 100%;
        }
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 400px;
        }
        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
        }
        .layer-list {
            font-size: 12px;
            margin-top: 10px;
        }
        .layer-item {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        .layer-item.active {
            color: #4CAF50;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="controls">
    <div class="test-section">
        <h4>üó∫Ô∏è Basemap Controls</h4>
        <div class="button-group">
            <button class="test-button primary" onclick="loadBasemapStandard()">
                Basemap Standard
            </button>
            <button class="test-button primary" onclick="loadSimpleBasemap()">
                Simple Raster Basemap
            </button>
        </div>
    </div>
    
    <div class="test-section">
        <h4>üìç WMS Overlays (Should Work)</h4>
        <div class="button-group">
            <button class="test-button secondary" onclick="addBEVWMS()">
                BEV DKM GST (WMS)
            </button>
            <button class="test-button secondary" onclick="addInspireWMS()">
                Inspire WMS
            </button>
        </div>
    </div>
    
    <div class="test-section">
        <h4>üî∑ Vector Overlays (Testing)</h4>
        <div class="button-group">
            <button class="test-button warning" onclick="addSimpleVectorOverlay()">
                Simple Vector Test
            </button>
            <button class="test-button warning" onclick="testProxiedKataster()">
                Proxied Kataster
            </button>
            <button class="test-button danger" onclick="clearAll()">
                Clear All
            </button>
        </div>
    </div>
    
    <div class="status" id="status">Ready</div>
</div>

<div id="map"></div>
<div class="coordinates" id="coordinates">Lat: 47.5000, Lng: 13.3000</div>

<div class="opacity-control">
    <label>Overlay Opacity: <span id="opacity-value">70%</span></label>
    <input type="range" id="opacity-slider" min="0" max="100" value="70" oninput="updateOpacity()" />
</div>

<div class="info-panel">
    <div class="info-title">Active Layers</div>
    <div id="layer-list" class="layer-list">
        <div class="layer-item">No layers loaded</div>
    </div>
</div>

<script>
let map = null;
let currentOverlays = {};

// Initialize map
function initMap() {
    if (map) {
        map.remove();
    }
    
    map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {},
            layers: []
        },
        center: [14.3053, 46.6364], // Klagenfurt
        zoom: 13
    });
    
    map.on('mousemove', (e) => {
        document.getElementById('coordinates').textContent = 
            `Lat: ${e.lngLat.lat.toFixed(4)}, Lng: ${e.lngLat.lng.toFixed(4)}`;
    });
    
    map.addControl(new maplibregl.NavigationControl());
    
    map.on('error', (e) => {
        console.error('Map error:', e);
        updateStatus('Map error: ' + (e.error?.message || 'Unknown'), 'error');
    });
}

// Update status
function updateStatus(message, type = 'info') {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.style.background = type === 'error' ? '#fee' : 
                               type === 'success' ? '#efe' : '#f8f9fa';
}

// Update layer list
function updateLayerList() {
    const list = document.getElementById('layer-list');
    const layers = map.getStyle().layers;
    
    if (layers.length === 0) {
        list.innerHTML = '<div class="layer-item">No layers loaded</div>';
        return;
    }
    
    list.innerHTML = layers.map(layer => 
        `<div class="layer-item ${currentOverlays[layer.source] ? 'active' : ''}">
            ${layer.id} (${layer.type})
        </div>`
    ).join('');
}

// Load simple raster basemap
function loadSimpleBasemap() {
    updateStatus('Loading simple basemap...');
    
    map.setStyle({
        version: 8,
        sources: {
            'basemap': {
                type: 'raster',
                tiles: ['https://mapsneu.wien.gv.at/basemap/geolandbasemap/normal/google3857/{z}/{y}/{x}.png'],
                tileSize: 256,
                attribution: '¬© basemap.at'
            }
        },
        layers: [{
            id: 'basemap-layer',
            type: 'raster',
            source: 'basemap'
        }]
    });
    
    map.once('style.load', () => {
        updateStatus('Simple basemap loaded', 'success');
        updateLayerList();
    });
}

// Load Basemap Standard
async function loadBasemapStandard() {
    updateStatus('Loading Basemap Standard...');
    
    try {
        const response = await fetch('https://gis.ktn.gv.at/osgdi/styles/basemap_ktn_vektor.json');
        const style = await response.json();
        
        map.setStyle(style);
        
        map.once('style.load', () => {
            updateStatus('Basemap Standard loaded', 'success');
            updateLayerList();
        });
    } catch (error) {
        console.error('Error loading basemap:', error);
        loadSimpleBasemap();
    }
}

// Add BEV DKM GST WMS
function addBEVWMS() {
    updateStatus('Adding BEV DKM GST WMS...');
    clearOverlays();
    
    const opacity = document.getElementById('opacity-slider').value / 100;
    
    try {
        // BEV DKM GST WMS URL
        const wmsUrl = 'https://data.bev.gv.at/geoserver/BEVdataKAT/wms';
        const tileUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX={bbox-epsg-3857}&CRS=EPSG:3857&WIDTH=256&HEIGHT=256&LAYERS=KAT_DKM_GST&STYLES=&FORMAT=image/png&TRANSPARENT=true`;
        
        map.addSource('bev-wms', {
            type: 'raster',
            tiles: [tileUrl],
            tileSize: 256
        });
        
        map.addLayer({
            id: 'bev-wms-layer',
            type: 'raster',
            source: 'bev-wms',
            paint: {
                'raster-opacity': opacity
            }
        });
        
        currentOverlays['bev-wms'] = true;
        updateStatus('BEV DKM GST WMS added successfully', 'success');
        updateLayerList();
        
        // Zoom to area with data
        map.flyTo({
            center: [14.3053, 46.6364], // Klagenfurt
            zoom: 16,
            duration: 1500
        });
    } catch (error) {
        console.error('Error adding BEV WMS:', error);
        updateStatus('Error adding BEV WMS: ' + error.message, 'error');
    }
}

// Add Inspire WMS
function addInspireWMS() {
    updateStatus('Adding Inspire WMS...');
    clearOverlays();
    
    const opacity = document.getElementById('opacity-slider').value / 100;
    
    try {
        // Fixed: Ensure layers is a string, not an array
        const wmsUrl = 'http://wsa.bev.gv.at/GeoServer/Interceptor/Wms/CP/INSPIRE_KUNDEN-2375336d-49b8-4e62-8640-6d6668ba100a';
        const layerName = 'CP.CadastralParcel_Parcel'; // Single layer as string
        const tileUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX={bbox-epsg-3857}&CRS=EPSG:3857&WIDTH=256&HEIGHT=256&LAYERS=${layerName}&STYLES=&FORMAT=image/png&TRANSPARENT=true`;
        
        map.addSource('inspire-wms', {
            type: 'raster',
            tiles: [tileUrl],
            tileSize: 256
        });
        
        map.addLayer({
            id: 'inspire-wms-layer',
            type: 'raster',
            source: 'inspire-wms',
            paint: {
                'raster-opacity': opacity
            }
        });
        
        currentOverlays['inspire-wms'] = true;
        updateStatus('Inspire WMS added (may need authentication)', 'success');
        updateLayerList();
        
        // Zoom to Vienna
        map.flyTo({
            center: [16.3738, 48.2082],
            zoom: 15,
            duration: 1500
        });
    } catch (error) {
        console.error('Error adding Inspire WMS:', error);
        updateStatus('Error adding Inspire WMS: ' + error.message, 'error');
    }
}

// Add simple vector overlay for testing
function addSimpleVectorOverlay() {
    updateStatus('Adding simple vector test overlay...');
    clearOverlays();
    
    const opacity = document.getElementById('opacity-slider').value / 100;
    
    try {
        // Create a simple GeoJSON source for testing
        map.addSource('test-vector', {
            type: 'geojson',
            data: {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[
                                [14.30, 46.63],
                                [14.31, 46.63],
                                [14.31, 46.64],
                                [14.30, 46.64],
                                [14.30, 46.63]
                            ]]
                        },
                        properties: { name: 'Test Parcel 1' }
                    },
                    {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [14.3053, 46.6364]
                        },
                        properties: { name: 'Test Point' }
                    }
                ]
            }
        });
        
        // Add polygon layer
        map.addLayer({
            id: 'test-vector-fill',
            type: 'fill',
            source: 'test-vector',
            filter: ['==', '$type', 'Polygon'],
            paint: {
                'fill-color': 'rgba(255, 0, 0, 0.1)',
                'fill-opacity': opacity * 0.5
            }
        });
        
        map.addLayer({
            id: 'test-vector-line',
            type: 'line',
            source: 'test-vector',
            filter: ['==', '$type', 'Polygon'],
            paint: {
                'line-color': '#ff0000',
                'line-width': 2,
                'line-opacity': opacity
            }
        });
        
        // Add point layer
        map.addLayer({
            id: 'test-vector-points',
            type: 'circle',
            source: 'test-vector',
            filter: ['==', '$type', 'Point'],
            paint: {
                'circle-radius': 8,
                'circle-color': '#0000ff',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': 2,
                'circle-opacity': opacity
            }
        });
        
        currentOverlays['test-vector'] = true;
        updateStatus('Simple vector test overlay added', 'success');
        updateLayerList();
    } catch (error) {
        console.error('Error adding test vector:', error);
        updateStatus('Error: ' + error.message, 'error');
    }
}

// Test proxied Kataster tiles
function testProxiedKataster() {
    updateStatus('Testing proxied Kataster tiles...');
    clearOverlays();
    
    const opacity = document.getElementById('opacity-slider').value / 100;
    
    try {
        // Use the proxied URL
        map.addSource('kataster-proxy', {
            type: 'vector',
            tiles: ['/kataster-tiles/styles/kataster/{z}/{x}/{y}.pbf'],
            minzoom: 0,
            maxzoom: 22
        });
        
        // Try different source-layer names that might exist
        const possibleLayers = [
            'Grundst√ºcke - Fl√§chen',
            'grundstuecke',
            'parcels',
            'default',
            'kataster'
        ];
        
        possibleLayers.forEach((layerName, index) => {
            try {
                map.addLayer({
                    id: `kataster-test-${index}`,
                    type: 'line',
                    source: 'kataster-proxy',
                    'source-layer': layerName,
                    paint: {
                        'line-color': ['case', 
                            ['==', index, 0], '#ff0000',
                            ['==', index, 1], '#00ff00',
                            ['==', index, 2], '#0000ff',
                            ['==', index, 3], '#ffff00',
                            '#ff00ff'
                        ],
                        'line-width': 2,
                        'line-opacity': opacity
                    }
                });
                console.log(`Added layer with source-layer: ${layerName}`);
            } catch (e) {
                console.log(`Failed to add layer with source-layer: ${layerName}`);
            }
        });
        
        currentOverlays['kataster-proxy'] = true;
        updateStatus('Testing various source-layer names - check console', 'success');
        updateLayerList();
        
        // Zoom to area with cadastral data
        map.flyTo({
            center: [14.3053, 46.6364],
            zoom: 17,
            duration: 1500
        });
    } catch (error) {
        console.error('Error adding proxied Kataster:', error);
        updateStatus('Error: ' + error.message, 'error');
    }
}

// Clear overlays
function clearOverlays() {
    Object.keys(currentOverlays).forEach(sourceId => {
        try {
            // Remove all layers using this source
            const layers = map.getStyle().layers.filter(l => l.source === sourceId);
            layers.forEach(layer => {
                if (map.getLayer(layer.id)) {
                    map.removeLayer(layer.id);
                }
            });
            // Remove source
            if (map.getSource(sourceId)) {
                map.removeSource(sourceId);
            }
        } catch (e) {
            console.error('Error removing overlay:', e);
        }
    });
    currentOverlays = {};
}

// Clear all
function clearAll() {
    clearOverlays();
    updateStatus('All overlays cleared', 'success');
    updateLayerList();
}

// Update opacity
function updateOpacity() {
    const opacity = document.getElementById('opacity-slider').value / 100;
    document.getElementById('opacity-value').textContent = `${document.getElementById('opacity-slider').value}%`;
    
    // Update all overlay layers
    const layers = map.getStyle().layers;
    layers.forEach(layer => {
        if (currentOverlays[layer.source]) {
            try {
                if (layer.type === 'raster') {
                    map.setPaintProperty(layer.id, 'raster-opacity', opacity);
                } else if (layer.type === 'fill') {
                    map.setPaintProperty(layer.id, 'fill-opacity', opacity * 0.5);
                } else if (layer.type === 'line') {
                    map.setPaintProperty(layer.id, 'line-opacity', opacity);
                } else if (layer.type === 'circle') {
                    map.setPaintProperty(layer.id, 'circle-opacity', opacity);
                }
            } catch (e) {
                console.error('Error updating opacity for layer:', layer.id);
            }
        }
    });
}

// Initialize on load
initMap();
loadSimpleBasemap();
</script>

</body>
</html>