<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test WMS Overlays - CORS Safe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map { 
            position: absolute; 
            top: 120px; 
            bottom: 0; 
            width: 100%; 
        }
        .controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.secondary {
            background: #2196F3;
        }
        .test-button.secondary:hover {
            background: #1976D2;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }
        .coordinates {
            position: absolute;
            top: 130px;
            right: 10px;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
            font-family: monospace;
        }
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 400px;
        }
        .info-title {
            font-weight: 600;
            margin-bottom: 10px;
        }
        .info-content {
            font-size: 13px;
            line-height: 1.5;
        }
        .overlay-control {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }
        .overlay-control label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .overlay-control input[type="range"] {
            width: 100%;
        }
    </style>
</head>
<body>

<div class="controls">
    <h3 style="margin: 0 0 10px 0;">WMS Overlay Test - CORS Safe Version</h3>
    <div class="test-buttons">
        <button class="test-button" onclick="testBasemapOnly()">
            Basemap Only
        </button>
        <button class="test-button secondary" onclick="testWithWMSOverlay()">
            Add BEV DKM GST (WMS)
        </button>
        <button class="test-button secondary" onclick="testWithInspireWMS()">
            Add Inspire WMS
        </button>
        <button class="test-button secondary" onclick="clearOverlays()">
            Clear Overlays
        </button>
    </div>
    <div class="overlay-control">
        <label>Overlay Opacity: <span id="opacity-value">70%</span></label>
        <input type="range" id="opacity-slider" min="0" max="100" value="70" onchange="updateOpacity()" />
    </div>
    <div class="status" id="status">Ready to test overlays</div>
</div>

<div id="map"></div>
<div class="coordinates" id="coordinates">Lat: 47.5000, Lng: 13.3000</div>

<div class="info-panel">
    <div class="info-title">Test Information</div>
    <div class="info-content">
        <p><strong>Current Test:</strong> This page tests WMS overlays which should work despite CORS restrictions.</p>
        <p><strong>Note:</strong> Vector tile overlays (like Kataster BEV2) require CORS headers from the tile server or a proxy.</p>
        <p><strong>Available WMS Overlays:</strong></p>
        <ul style="margin: 5px 0; padding-left: 20px;">
            <li>BEV DKM GST - Cadastral WMS service</li>
            <li>Inspire WMS - INSPIRE compliant cadastral parcels</li>
        </ul>
    </div>
</div>

<script>
let map = null;
let currentOverlays = {};

// Initialize map with Basemap Standard
function initMap() {
    // Remove existing map if any
    if (map) {
        map.remove();
    }
    
    // Use a simple basemap that works
    map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {
                'basemap': {
                    type: 'raster',
                    tiles: ['https://mapsneu.wien.gv.at/basemap/geolandbasemap/normal/google3857/{z}/{y}/{x}.png'],
                    tileSize: 256,
                    attribution: 'Â© basemap.at'
                }
            },
            layers: [{
                id: 'basemap-layer',
                type: 'raster',
                source: 'basemap'
            }]
        },
        center: [13.3, 47.5], // Austria center
        zoom: 7
    });
    
    map.on('load', () => {
        document.getElementById('status').textContent = 'Basemap loaded successfully';
    });
    
    map.on('error', (e) => {
        console.error('Map error:', e);
        document.getElementById('status').textContent = 'Map error: ' + (e.error?.message || 'Unknown error');
    });
    
    // Update coordinates on mouse move
    map.on('mousemove', (e) => {
        document.getElementById('coordinates').textContent = 
            `Lat: ${e.lngLat.lat.toFixed(4)}, Lng: ${e.lngLat.lng.toFixed(4)}`;
    });
    
    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl());
}

// Test basemap only
function testBasemapOnly() {
    clearOverlays();
    document.getElementById('status').textContent = 'Showing basemap only';
}

// Add BEV DKM GST WMS overlay
function testWithWMSOverlay() {
    clearOverlays();
    
    const opacity = document.getElementById('opacity-slider').value / 100;
    
    // BEV DKM GST WMS
    const wmsUrl = 'https://data.bev.gv.at/geoserver/BEVdataKAT/wms';
    const tileUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX={bbox-epsg-3857}&CRS=EPSG:3857&WIDTH=256&HEIGHT=256&LAYERS=KAT_DKM_GST&STYLES=&FORMAT=image/png&TRANSPARENT=true`;
    
    try {
        map.addSource('overlay-bev-dkm', {
            type: 'raster',
            tiles: [tileUrl],
            tileSize: 256
        });
        
        map.addLayer({
            id: 'overlay-bev-dkm-layer',
            type: 'raster',
            source: 'overlay-bev-dkm',
            paint: {
                'raster-opacity': opacity
            }
        });
        
        currentOverlays['bev-dkm'] = true;
        document.getElementById('status').textContent = 'Added BEV DKM GST WMS overlay';
        
        // Zoom to a specific area to see the cadastral data
        map.flyTo({
            center: [14.3053, 46.6364], // Klagenfurt
            zoom: 15,
            duration: 2000
        });
    } catch (error) {
        console.error('Error adding WMS overlay:', error);
        document.getElementById('status').textContent = 'Error adding overlay: ' + error.message;
    }
}

// Add Inspire WMS overlay
function testWithInspireWMS() {
    clearOverlays();
    
    const opacity = document.getElementById('opacity-slider').value / 100;
    
    // Note: This URL might need authentication
    const wmsUrl = 'http://wsa.bev.gv.at/GeoServer/Interceptor/Wms/CP/INSPIRE_KUNDEN-2375336d-49b8-4e62-8640-6d6668ba100a';
    const tileUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX={bbox-epsg-3857}&CRS=EPSG:3857&WIDTH=256&HEIGHT=256&LAYERS=CP.CadastralParcel_Parcel&STYLES=&FORMAT=image/png&TRANSPARENT=true`;
    
    try {
        map.addSource('overlay-inspire', {
            type: 'raster',
            tiles: [tileUrl],
            tileSize: 256
        });
        
        map.addLayer({
            id: 'overlay-inspire-layer',
            type: 'raster',
            source: 'overlay-inspire',
            paint: {
                'raster-opacity': opacity
            }
        });
        
        currentOverlays['inspire'] = true;
        document.getElementById('status').textContent = 'Added Inspire WMS overlay (may require authentication)';
        
        // Zoom to a specific area
        map.flyTo({
            center: [16.3738, 48.2082], // Vienna
            zoom: 14,
            duration: 2000
        });
    } catch (error) {
        console.error('Error adding Inspire WMS:', error);
        document.getElementById('status').textContent = 'Error adding overlay: ' + error.message;
    }
}

// Clear all overlays
function clearOverlays() {
    Object.keys(currentOverlays).forEach(overlayId => {
        try {
            if (map.getLayer(`overlay-${overlayId}-layer`)) {
                map.removeLayer(`overlay-${overlayId}-layer`);
            }
            if (map.getSource(`overlay-${overlayId}`)) {
                map.removeSource(`overlay-${overlayId}`);
            }
        } catch (e) {
            console.error('Error removing overlay:', e);
        }
    });
    currentOverlays = {};
    document.getElementById('status').textContent = 'Overlays cleared';
}

// Update overlay opacity
function updateOpacity() {
    const opacity = document.getElementById('opacity-slider').value / 100;
    document.getElementById('opacity-value').textContent = `${document.getElementById('opacity-slider').value}%`;
    
    // Update opacity for all overlay layers
    Object.keys(currentOverlays).forEach(overlayId => {
        try {
            if (map.getLayer(`overlay-${overlayId}-layer`)) {
                map.setPaintProperty(`overlay-${overlayId}-layer`, 'raster-opacity', opacity);
            }
        } catch (e) {
            console.error('Error updating opacity:', e);
        }
    });
}

// Initialize map on page load
initMap();
</script>

</body>
</html>