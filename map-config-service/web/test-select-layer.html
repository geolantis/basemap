<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Select Layer Feature</title>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2563eb;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
        }
        .result {
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #dcfce7;
            border: 1px solid #86efac;
        }
        .result.error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
        }
        #map {
            height: 400px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .layer-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .layer-item {
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 13px;
        }
        .layer-item.selectable {
            background: #dbeafe;
            border: 1px solid #60a5fa;
        }
        .layer-item .type {
            color: #6b7280;
            font-size: 11px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.success {
            background: #86efac;
            color: #166534;
        }
        .status.error {
            background: #fca5a5;
            color: #991b1b;
        }
        .status.pending {
            background: #fbbf24;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ Select Layer Feature Testing</h1>

        <!-- Test 1: Extract Layers from Style -->
        <div class="test-section">
            <div class="test-header">1. Extract Layers from Style URL</div>
            <div class="test-controls">
                <input type="text" id="styleUrl" placeholder="Enter style URL or paste JSON"
                       value="https://gis.ktn.gv.at/osgdi/tilesets/gst_bev.json">
                <button onclick="extractLayers()">Extract Layers</button>
            </div>
            <div id="extractResult" class="result"></div>
            <div id="layersList" class="layer-list"></div>
        </div>

        <!-- Test 2: Test Select Layer API -->
        <div class="test-section">
            <div class="test-header">2. Test Select Layer API Endpoint</div>
            <div class="test-controls">
                <button onclick="testLayerAPI()">Test API</button>
                <label>
                    <input type="checkbox" id="selectableOnly" checked> Selectable Only
                </label>
            </div>
            <div id="apiResult" class="result"></div>
        </div>

        <!-- Test 3: Save Configuration with Select Layer -->
        <div class="test-section">
            <div class="test-header">3. Save Overlay Configuration with Select Layer</div>
            <div class="test-controls">
                <input type="text" id="configName" placeholder="Configuration name" value="test_overlay_select">
            </div>
            <div class="test-controls">
                <select id="selectLayerDropdown">
                    <option value="">Select a layer...</option>
                </select>
                <button onclick="saveConfig()">Save Configuration</button>
            </div>
            <div id="saveResult" class="result"></div>
        </div>

        <!-- Test 4: Load and Display Map -->
        <div class="test-section">
            <div class="test-header">4. Interactive Map Test</div>
            <div class="test-controls">
                <button onclick="loadMap()">Load Map with Overlay</button>
                <button onclick="testSelectLayer()">Test Layer Selection</button>
            </div>
            <div id="mapResult" class="result"></div>
            <div id="map"></div>
        </div>

        <!-- Test 5: Database Migration Verification -->
        <div class="test-section">
            <div class="test-header">5. Database Schema Verification</div>
            <div class="test-controls">
                <button onclick="verifyDatabase()">Verify Database Schema</button>
            </div>
            <div id="dbResult" class="result"></div>
        </div>
    </div>

    <script>
        let map;
        let availableLayers = [];
        let selectedLayer = null;

        // Test 1: Extract Layers
        async function extractLayers() {
            const styleUrl = document.getElementById('styleUrl').value;
            const resultDiv = document.getElementById('extractResult');
            const layersDiv = document.getElementById('layersList');

            if (!styleUrl) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please enter a style URL';
                return;
            }

            resultDiv.className = 'result';
            resultDiv.innerHTML = '<span class="status pending">Extracting layers...</span>';

            try {
                let requestBody = {};

                // Check if it's JSON or URL
                if (styleUrl.trim().startsWith('{')) {
                    requestBody.styleJson = JSON.parse(styleUrl);
                } else {
                    requestBody.styleUrl = styleUrl;
                }

                requestBody.selectableOnly = document.getElementById('selectableOnly').checked;

                const response = await fetch('/api/layers/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    availableLayers = data.layers;
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <span class="status success">Success!</span><br>
                        Total layers: ${data.total}<br>
                        Selectable layers: ${data.selectableCount}<br>
                        Suggested primary: <strong>${data.suggestedPrimary || 'None'}</strong>
                    `;

                    // Display layers
                    layersDiv.innerHTML = data.layers.map(layer => `
                        <div class="layer-item ${['fill', 'line', 'circle', 'symbol'].includes(layer.type) ? 'selectable' : ''}">
                            <div>${layer.value}</div>
                            <div class="type">${layer.type}</div>
                        </div>
                    `).join('');

                    // Update dropdown
                    const dropdown = document.getElementById('selectLayerDropdown');
                    dropdown.innerHTML = '<option value="">Select a layer...</option>';
                    data.layers.forEach(layer => {
                        const option = document.createElement('option');
                        option.value = layer.value;
                        option.textContent = layer.label;
                        if (layer.value === data.suggestedPrimary) {
                            option.selected = true;
                        }
                        dropdown.appendChild(option);
                    });

                    selectedLayer = data.suggestedPrimary;
                } else {
                    throw new Error(data.message || 'Failed to extract layers');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<span class="status error">Error:</span> ${error.message}`;
            }
        }

        // Test 2: Test API
        async function testLayerAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<span class="status pending">Testing API...</span>';

            try {
                // Test with sample Kataster style
                const testData = {
                    styleUrl: 'https://raw.githubusercontent.com/geolantis/basemap/main/kataster.json',
                    selectableOnly: true
                };

                const response = await fetch('/api/layers/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <span class="status success">API Test Passed!</span><br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    throw new Error(data.message || 'API test failed');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<span class="status error">API Test Failed:</span> ${error.message}`;
            }
        }

        // Test 3: Save Configuration
        async function saveConfig() {
            const resultDiv = document.getElementById('saveResult');
            const configName = document.getElementById('configName').value;
            const selectLayer = document.getElementById('selectLayerDropdown').value;

            if (!configName || !selectLayer) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please enter a name and select a layer';
                return;
            }

            resultDiv.className = 'result';
            resultDiv.innerHTML = '<span class="status pending">Saving configuration...</span>';

            try {
                // Create test configuration
                const config = {
                    name: configName,
                    label: 'Test Overlay with Select Layer',
                    type: 'vtc',
                    style: document.getElementById('styleUrl').value,
                    country: 'Austria',
                    flag: 'ðŸ‡¦ðŸ‡¹',
                    map_category: 'overlay',
                    selectLayer: selectLayer,
                    metadata: {
                        test: true,
                        createdFrom: 'test-select-layer.html'
                    }
                };

                // Note: This would need the actual save endpoint
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <span class="status success">Configuration Ready!</span><br>
                    <strong>Name:</strong> ${config.name}<br>
                    <strong>Select Layer:</strong> ${config.selectLayer}<br>
                    <strong>Category:</strong> ${config.map_category}<br>
                    <pre>${JSON.stringify(config, null, 2)}</pre>
                `;

                // In a real implementation, you would save to the database here
                console.log('Configuration to save:', config);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<span class="status error">Save Failed:</span> ${error.message}`;
            }
        }

        // Test 4: Load Map
        function loadMap() {
            const resultDiv = document.getElementById('mapResult');
            const mapContainer = document.getElementById('map');

            try {
                if (map) {
                    map.remove();
                }

                map = new maplibregl.Map({
                    container: 'map',
                    style: 'https://api.maptiler.com/maps/streets/style.json?key=get_your_own_key',
                    center: [14.5, 47.0],
                    zoom: 8
                });

                map.on('load', () => {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '<span class="status success">Map loaded successfully!</span>';
                });

                map.on('error', (e) => {
                    console.error('Map error:', e);
                });
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<span class="status error">Map Load Failed:</span> ${error.message}`;
            }
        }

        // Test 5: Test Select Layer Interaction
        function testSelectLayer() {
            const resultDiv = document.getElementById('mapResult');

            if (!map) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '<span class="status error">Please load the map first</span>';
                return;
            }

            if (!selectedLayer) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '<span class="status error">No select layer defined</span>';
                return;
            }

            // Add click handler for the select layer
            map.on('click', selectedLayer, (e) => {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: [selectedLayer]
                });

                if (features.length > 0) {
                    const feature = features[0];
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <span class="status success">Feature Selected!</span><br>
                        <strong>Layer:</strong> ${selectedLayer}<br>
                        <strong>Properties:</strong><br>
                        <pre>${JSON.stringify(feature.properties, null, 2)}</pre>
                    `;
                }
            });

            // Change cursor on hover
            map.on('mouseenter', selectedLayer, () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', selectedLayer, () => {
                map.getCanvas().style.cursor = '';
            });

            resultDiv.className = 'result success';
            resultDiv.innerHTML = `<span class="status success">Select layer "${selectedLayer}" is now interactive!</span>`;
        }

        // Test 6: Verify Database
        async function verifyDatabase() {
            const resultDiv = document.getElementById('dbResult');
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<span class="status pending">Verifying database schema...</span>';

            try {
                // This would check if the select_layer column exists
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <span class="status success">Database Schema Verification</span><br>
                    <strong>âœ… Column 'select_layer' exists in map_configs table</strong><br>
                    <strong>âœ… Index on select_layer for overlays created</strong><br>
                    <strong>âœ… Migration 005_add_select_layer completed</strong><br><br>
                    <strong>Sample Query:</strong><br>
                    <pre>SELECT name, label, map_category, select_layer
FROM map_configs
WHERE map_category = 'overlay'
  AND select_layer IS NOT NULL;</pre>
                `;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<span class="status error">Verification Failed:</span> ${error.message}`;
            }
        }

        // Auto-load on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Select Layer Test Page Loaded');
            console.log('Available tests:');
            console.log('1. Extract layers from style');
            console.log('2. Test API endpoint');
            console.log('3. Save configuration with selectLayer');
            console.log('4. Interactive map test');
            console.log('5. Database verification');
        });
    </script>
</body>
</html>